<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/assets/css/base.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #74ebd5 0%, #ACB6E5 100%);
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Montserrat', Arial, sans-serif;
    }
    .login-container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 6px 38px #1565c033, 0 1.5px 6px #74ebd522;
      padding: 44px 32px 32px 32px;
      max-width: 350px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1.5px solid #74ebd580;
      animation: fadeInUp 1s;
    }
    @keyframes fadeInUp {
      from { transform: translateY(40px); opacity: 0;}
      to { transform: translateY(0); opacity: 1;}
    }
    .login-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .login-logo img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 8px #74ebd555;
    }
    .login-logo span {
      color: #1976d2;
      font-weight: bold;
      font-size: 1.15em;
      letter-spacing: 1.2px;
      text-shadow: 0 2px 12px #1565c044;
    }
    .login-container h2 {
      color: #1565c0;
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 1.45em;
      letter-spacing: 1px;
      text-align: center;
      text-shadow: 0 2px 12px #1976d233;
    }
    .input-group {
      width: 100%;
      margin-bottom: 18px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      position: relative;
    }
    .input-group label {
      grid-column: 1 / -1;
      display: block;
      color: #1976d2;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 1em;
      letter-spacing: .4px;
    }
    .input-group input {
      grid-column: 1 / 2;
      width: 100%;
      height: 48px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1.5px solid #74ebd5;
      background: #f4fafd;
      font-size: 1.05em;
      font-family: inherit;
      color: #1565c0;
      outline: none;
      transition: border .2s, box-shadow .18s;
      box-shadow: 0 1px 5px #74ebd522;
      box-sizing: border-box;
      line-height: 48px;
      vertical-align: middle;
      display: block;
    }
    .input-group input:focus {
      border-color: #1976d2;
      box-shadow: 0 2px 12px #74ebd533;
    }
    .input-group .toggle-password {
      grid-column: 2 / 3;
      height: 40px;
      width: 40px;
      margin-left: -40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      font-size: 1.5em;
      color: #1976d2b3;
      z-index: 2;
      padding: 0;
      outline: none;
      cursor: pointer;
    }
    .input-group .toggle-password svg {
      width: 28px;
      height: 28px;
      display: block;
      pointer-events: none;
    }
    .input-group .toggle-password:hover {
      color: #1976d2;
    }
    .login-container button[type="submit"] {
      width: 100%;
      padding: 13px 0;
      border-radius: 14px;
      background: linear-gradient(90deg, #1976d2 80%, #74ebd5 140%);
      color: #fff;
      border: none;
      font-size: 1.09em;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 2px 16px #1565c033;
      letter-spacing: .5px;
      transition: background .18s, transform .13s;
    }
    .login-container button[type="submit"]:hover {
      background: linear-gradient(90deg, #1976d2 65%, #00c6fb 130%);
      transform: scale(1.04);
    }
    .mensaje {
      color: #e53935;
      text-align: center;
      margin-top: 15px;
      min-height: 22px;
      font-size: 1em;
      letter-spacing: .2px;
      font-weight: 600;
    }
    @media (max-width: 500px) {
      .login-container {
        padding: 18px 3vw;
        max-width: 97vw;
      }
      .login-logo img {
        width: 32px;
        height: 32px;
      }
      .input-group input {
        height: 44px;
        line-height: 44px;
      }
      .input-group .toggle-password {
        height: 34px;
        width: 34px;
        margin-left: -34px;
      }
      .input-group .toggle-password svg {
        width: 20px;
        height: 20px;
      }
    }
  </style>
  <script>
    // Si el usuario ya está logueado, redirige a index.html en la raíz
    if (localStorage.getItem('usuario')) {
      window.location.href = '../index.html';
    }
  </script>
</head>
<body>
  <form class="login-container" id="formLogin" autocomplete="off">
    <div class="login-logo">
      <img src="/assets/img/Logo.png" alt="Logo E.E.S.T N°4">
      <span>E.E.S.T N°4</span>
    </div>
    <h2>Iniciar sesión</h2>
    <div class="input-group">
      <label for="usuario">Usuario</label>
      <input type="text" id="usuario" placeholder="Usuario" required autofocus>
    </div>
    <div class="input-group">
      <label for="clave">Contraseña</label>
      <input type="password" id="clave" placeholder="Contraseña" required>
      <button type="button" class="toggle-password" id="togglePassword" tabindex="-1" aria-label="Mostrar/ocultar contraseña">
        <svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
    </div>
    <button type="submit">Entrar</button>
    <div class="mensaje" id="mensaje"></div>
  </form>
<script>
  // OJITO CONTRASEÑA
  const claveInput = document.getElementById('clave');
  const togglePasswordBtn = document.getElementById('togglePassword');
  const eyeIcon = document.getElementById('eyeIcon');
  let passwordVisible = false;
  togglePasswordBtn.addEventListener('click', function() {
    passwordVisible = !passwordVisible;
    claveInput.type = passwordVisible ? 'text' : 'password';

    // Cambia el icono SVG según el estado
    if (passwordVisible) {
      eyeIcon.innerHTML = `<path d="M17.94 17.94A10.06 10.06 0 0 1 12 19c-7 0-11-7-11-7a21.36 21.36 0 0 1 5.06-6.06M1 1l22 22"/><circle cx="12" cy="12" r="3"/>`;
    } else {
      eyeIcon.innerHTML = `<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/>`;
    }
  });

  document.getElementById('formLogin').addEventListener('submit', async function(e){
    e.preventDefault();
    // Envía siempre el usuario en minúsculas (case-insensitive)
    const nombre = document.getElementById('usuario').value.trim().toLowerCase();
    const pass = document.getElementById('clave').value;
    const msj = document.getElementById('mensaje');
    msj.textContent = '';
    try{
      const res = await fetch('http://localhost:3000/api/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ nombre, pass })
      });
      const data = await res.json();
      if(data.success){
        // GUARDA id_usuario, rol Y nombre EN EL LOCALSTORAGE
        let id_usuario = data.usuario.id_usuario || data.usuario.id;
        let rol = data.usuario.rol || data.usuario.id_rol;
        let nombreUsuario = data.usuario.nombre || nombre; // usa el nombre que llega del backend o el que se ingresó
        localStorage.setItem('usuario', JSON.stringify({
          id_usuario: Number(id_usuario),
          rol: Number(rol),
          nombre: nombreUsuario
        }));
        window.location.href = '../index.html';
      }else{
        msj.textContent = data.error || "Error de autenticación";
      }
    }catch(err){
      msj.textContent = "No se pudo conectar al servidor";
    }
  });
</script>
</body>
</html>